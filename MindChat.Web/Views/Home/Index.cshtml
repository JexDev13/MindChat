@{
    ViewData["Title"] = "MindChat";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var activeProfile = (ViewData["ActiveProfile"] as string ?? "Patient");
    var userName = ViewData["UserName"] as string ?? "";
    var chats = ViewData["Chats"] as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var psychologists = ViewData["Psychologists"] as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var appointments = ViewData["Appointments"] as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var pendingRequests = ViewData["PendingRequests"] as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var currentChatId = ViewData["ChatId"] ?? 1;
    var userId = (int)(ViewData["UserId"] ?? 0);
    var hasBothProfiles = (bool)(ViewData["HasBothProfiles"] ?? false);
    var isProfileVisible = (bool)(ViewData["IsProfileVisible"] ?? false);
}

<div>
    <div>
        <h2>Bienvenido, @userName</h2>

        @* Botón "Ocultar perfil" solo para psicólogos *@
        @if (string.Equals(activeProfile, "Psychologist", StringComparison.OrdinalIgnoreCase))
        {
            <form method="post" asp-action="ToggleProfileVisibility" asp-controller="Home">
                @Html.AntiForgeryToken()
                <button type="submit">
                    @(isProfileVisible ? "Ocultar perfil" : "Mostrar perfil")
                </button>
            </form>
        }

        <form method="post" asp-action="Logout">
            @Html.AntiForgeryToken()
            <button type="submit">Cerrar sesión</button>
        </form>

        @* Botón "Cambiar perfil" solo para usuarios con ambos perfiles *@
        @if (hasBothProfiles)
        {
            <form method="post" asp-action="SwitchProfile">
                @Html.AntiForgeryToken()
                <button type="submit">
                    Cambiar a @(activeProfile == "Patient" ? "Psicólogo" : "Paciente")
                </button>
            </form>
        }
    </div>

    <!-- Sección: Notificaciones -->
    <div>
        <h3>Notificaciones</h3>
        <div id="notifications-container">
            @if (string.Equals(activeProfile, "Psychologist", StringComparison.OrdinalIgnoreCase))
            {
                @if (!pendingRequests.Any())
                {
                    <p>No tienes solicitudes de chat pendientes.</p>
                }
                else
                {
                    <div id="pending-requests">
                        @foreach (var request in pendingRequests)
                        {
                            <div class="notification-item" data-request-id="@request.Id">
                                <h5>Solicitud de Chat</h5>
                                <p><strong>Paciente:</strong> @(request.Patient?.User?.FullName ?? "Paciente")</p>
                                <p><strong>Mensaje:</strong> @request.InitialMessage</p>
                                <div>
                                    <button type="button" class="btn-accept" data-request-id="@request.Id" 
                                            >
                                        Aceptar
                                    </button>
                                    <button type="button" class="btn-reject" data-request-id="@request.Id"
                                            >
                                        Rechazar
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            else
            {
                <p>Las notificaciones de respuesta aparecerán aquí.</p>
            }
        </div>
    </div>

    <div>
        <!-- Sección: User Profile (siempre visible) -->
        <div>
            <h3>Perfil de Usuario</h3>
            <p>Nombre: @userName</p>
            <p>Perfil activo: @activeProfile</p>
            @if (string.Equals(activeProfile, "Psychologist", StringComparison.OrdinalIgnoreCase))
            {
                <p>Estado del perfil: @(isProfileVisible ? "Visible para pacientes" : "Oculto para pacientes")</p>
            }
        </div>

        <!-- Sección: Chats (siempre visible) -->
        <div>
            <h3>Chats</h3>
            @if (!chats.Any())
            {
                <p>No hay chats disponibles.</p>
            }
            else
            {
                <ul>
                    @foreach (var chat in chats)
                    {
                        var lastMessage = (chat.Messages != null && ((IEnumerable<dynamic>)chat.Messages).Any())
                        ? ((IEnumerable<dynamic>)chat.Messages).Last().Message
                        : "Sin mensajes";
                        <li>
                            <strong>Chat #@chat.Id</strong>
                            <div>@lastMessage</div>
                        </li>
                    }
                </ul>
            }
        </div>

        <!-- Si el perfil activo es Patient: listar psicólogos visibles -->
        @if (string.Equals(activeProfile, "Patient", StringComparison.OrdinalIgnoreCase))
        {
            <div>
                <h3>Psicólogos Disponibles</h3>
                @if (!psychologists.Any())
                {
                    <p>No hay psicólogos visibles en este momento.</p>
                }
                else
                {
                    <ul>
                        @foreach (var psy in psychologists)
                        {
                            <li>
                                <div>
                                    <strong>@(psy.User?.FullName ?? "Psicólogo")</strong>
                                    @if (!string.IsNullOrEmpty(psy.Bio))
                                    {
                                        <div>@psy.Bio</div>
                                    }
                                    <div>
                                        <form method="post" asp-action="Create" asp-controller="SessionRequest" style="display: inline;">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="psychologistId" value="@psy.Id" />
                                            <button type="submit" class="start-chat-btn">Solicitar chat</button>
                                        </form>
                                    </div>
                                </div>
                            </li>
                        }
                    </ul>
                }

                <h3>Mis Citas</h3>
                @if (!appointments.Any())
                {
                    <p>No tienes citas programadas.</p>
                }
                else
                {
                    <ul>
                        @foreach (var appt in appointments.Where(a => a.PatientId == userId))
                        {
                            var psychologistName = appt.Psychologist?.User?.FullName ?? "Psicólogo";
                            <li>
                                <div>
                                    <strong>@psychologistName</strong> - @((DateTime)appt.ScheduledAt).ToString("g")
                                    @if (!string.IsNullOrEmpty(appt.Notes))
                                    {
                                        <div>@appt.Notes</div>
                                    }
                                </div>
                            </li>
                        }
                    </ul>
                }
            </div>
        }
        else if (string.Equals(activeProfile, "Psychologist", StringComparison.OrdinalIgnoreCase))
        {
            <!-- Si el perfil activo es Psychologist: listar citas -->
            <div>
                <h3>Mis Citas</h3>
                @if (!appointments.Any())
                {
                    <p>No hay citas programadas.</p>
                }
                else
                {
                    <ul>
                        @foreach (var appt in appointments)
                        {
                            var patientName = appt.Patient?.User?.FullName ?? "Paciente";
                            <li>
                                <div>
                                    <strong>@patientName</strong> - @((DateTime)appt.ScheduledAt).ToString("g")
                                    @if (!string.IsNullOrEmpty(appt.Notes))
                                    {
                                        <div>@appt.Notes</div>
                                    }
                                </div>
                            </li>
                        }
                    </ul>
                }
            </div>
        }

        <!-- Sección: Chat Web -->
        <div>
            <h3>Chat</h3>
            <div id="messages"></div>
            <input type="text" id="messageInput" placeholder="Escribe un mensaje..." />
            <button id="sendBtn">Enviar</button>
            <div id="connectionStatus"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <script>
        const userName = "@userName";
        const userId = "@userId";
        
        // Conexión para notificaciones
        const notificationConnection = new signalR.HubConnectionBuilder()
            .withUrl("/notificationhub")
            .withAutomaticReconnect()
            .build();

        // Conexión para chat (existente)
        let chatId = @currentChatId;
        const statusDiv = document.getElementById("connectionStatus");
        const messagesDiv = document.getElementById("messages");

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub")
            .withAutomaticReconnect()
            .build();

        function showStatus(message) { 
            if (statusDiv) statusDiv.textContent = message; 
        }

        // Manejar notificaciones de solicitudes de chat
        notificationConnection.on("ReceiveChatRequest", (data) => {
            const container = document.getElementById("notifications-container");
            const newNotification = document.createElement("div");
            newNotification.className = "notification-item";
            newNotification.setAttribute("data-request-id", data.SessionRequestId);
            newNotification.style.cssText = "margin-bottom: 15px; padding: 15px; border: 2px solid #007bff; border-radius: 8px; background-color: #f8f9fa;";
            
            newNotification.innerHTML = `
                <h5>Nueva Solicitud de Chat</h5>
                <p><strong>Paciente:</strong> ${data.PatientName}</p>
                <p><strong>Mensaje:</strong> ${data.InitialMessage}</p>
                <div>
                    <button type="button" class="btn-accept" data-request-id="${data.SessionRequestId}" 
                            style="background-color: #28a745; color: white; border: none; padding: 8px 16px; margin-right: 10px; border-radius: 4px; cursor: pointer;">
                        Aceptar
                    </button>
                    <button type="button" class="btn-reject" data-request-id="${data.SessionRequestId}"
                            style="background-color: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                        Rechazar
                    </button>
                </div>
            `;
            
            container.prepend(newNotification);
        });

        // Manejar respuestas a solicitudes de chat
        notificationConnection.on("ReceiveChatRequestResponse", (data) => {
            const container = document.getElementById("notifications-container");
            const responseNotification = document.createElement("div");
            responseNotification.style.cssText = "margin-bottom: 15px; padding: 15px; border: 2px solid " + (data.Accepted ? "#28a745" : "#dc3545") + "; border-radius: 8px; background-color: #f8f9fa;";
            
            responseNotification.innerHTML = `
                <h5>${data.Accepted ? 'Solicitud Aceptada' : 'Solicitud Rechazada'}</h5>
                <p><strong>Psicólogo:</strong> ${data.PsychologistName}</p>
                <p>${data.Accepted ? 'Tu solicitud de chat ha sido aceptada. Puedes comenzar a chatear.' : 'Tu solicitud de chat ha sido rechazada.'}</p>
            `;
            
            container.prepend(responseNotification);
        });

        // Iniciar conexión de notificaciones
        notificationConnection.start()
            .then(() => {
                console.log("Conexión de notificaciones iniciada");
                notificationConnection.invoke("JoinUserGroup", userId);
            })
            .catch(err => console.error("Error al conectar notificaciones:", err));

        // Manejar clics en botones de aceptar/rechazar
        document.addEventListener("click", function(e) {
            if (e.target.classList.contains("btn-accept")) {
                const requestId = e.target.getAttribute("data-request-id");
                handleSessionRequest(requestId, "Accept", e.target.closest(".notification-item"));
            } else if (e.target.classList.contains("btn-reject")) {
                const requestId = e.target.getAttribute("data-request-id");
                handleSessionRequest(requestId, "Reject", e.target.closest(".notification-item"));
            }
        });

        function handleSessionRequest(requestId, action, notificationElement) {
            fetch(`/SessionRequest/${action}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "RequestVerificationToken": document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: `sessionRequestId=${requestId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    notificationElement.style.opacity = "0.5";
                    notificationElement.innerHTML = `
                        <h5>Solicitud ${action === "Accept" ? "Aceptada" : "Rechazada"}</h5>
                        <p>La solicitud ha sido procesada correctamente.</p>
                    `;
                    
                    setTimeout(() => {
                        notificationElement.remove();
                    }, 3000);
                } else {
                    alert("Error: " + data.error);
                }
            })
            .catch(err => {
                console.error("Error:", err);
                alert("Error al procesar la solicitud");
            });
        }

        // Resto del código de chat existente...
        if (connection) {
            connection.on("ReceiveMessage", (chatIdReceived, message, sender) => {
                if (chatIdReceived === chatId && messagesDiv) {
                    messagesDiv.innerHTML += `<div><strong>${sender}:</strong> ${message}</div>`;
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            });

            connection.onreconnecting(() => showStatus("Reconectando..."));
            connection.onreconnected(() => {
                showStatus("Reconectado");
                connection.invoke("JoinChat", chatId);
            });
            connection.onclose(() => {
                showStatus("Conexión perdida. Recargando...");
                setTimeout(() => location.reload(), 2000);
            });

            connection.start()
                .then(() => connection.invoke("JoinChat", chatId).then(() => showStatus("Conectado")))
                .catch(() => { showStatus("Error al conectar. Recargando..."); setTimeout(() => location.reload(), 2000); });
        }

        function sendMessage() {
            const input = document.getElementById("messageInput");
            const message = input?.value?.trim();
            if (message && connection) {
                connection.invoke("SendMessage", chatId, message, userName)
                    .then(() => input.value = "")
                    .catch(() => showStatus("Error al enviar mensaje"));
            }
        }

        document.getElementById("sendBtn")?.addEventListener("click", sendMessage);
        document.getElementById("messageInput")?.addEventListener("keypress", e => {
            if (e.key === 'Enter') { sendMessage(); e.preventDefault(); }
        });

        window.addEventListener("beforeunload", () => {
            if (connection && connection.state === signalR.HubConnectionState.Connected) {
                connection.invoke("LeaveChat", chatId);
            }
            if (notificationConnection && notificationConnection.state === signalR.HubConnectionState.Connected) {
                notificationConnection.invoke("LeaveUserGroup", userId);
            }
        });
    </script>
}