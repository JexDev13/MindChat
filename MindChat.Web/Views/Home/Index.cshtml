@{
    ViewData["Title"] = "MindChat";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // ... (Variables de Razor) ...
    var activeProfile = (ViewData["ActiveProfile"] as string ?? "Patient");
    var userName = ViewData["UserName"] as string ?? "";
    var chats = ViewData["Chats"] as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var psychologists = ViewData["Psychologists"] as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var appointments = ViewData["Appointments"] as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var pendingRequests = ViewData["PendingRequests"] as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var currentChatId = ViewData["ChatId"] ?? 1;
    var userId = (int)(ViewData["UserId"] ?? 0);
    var hasBothProfiles = (bool)(ViewData["HasBothProfiles"] ?? false);
    var isProfileVisible = (bool)(ViewData["IsProfileVisible"] ?? false);
}

<div class="home-container">

    <div class="main-panels">

        <div class="top-actions">
            <h2 class="h4 mb-0 me-auto">
                Bienvenido,
                <span class="text-info d-inline-block text-truncate" style="max-width: 150px;">
                    @userName
                </span>
            </h2>

            @* Botones de acción superior *@
            @if (string.Equals(activeProfile, "Psychologist", StringComparison.OrdinalIgnoreCase))
            {
                <form method="post" asp-action="ToggleProfileVisibility" asp-controller="Home" class="d-inline-block">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-sm btn-outline-info">
                        <i class="bi bi-eye"></i> @(isProfileVisible ? "Ocultar perfil" : "Mostrar perfil")
                    </button>
                </form>
            }

            @if (hasBothProfiles)
            {
                <form method="post" asp-action="SwitchProfile" class="d-inline-block">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-sm btn-outline-light">
                        Cambiar a @(activeProfile == "Patient" ? "Psicólogo" : "Paciente")
                    </button>
                </form>
            }

            <form method="post" asp-action="Logout" class="d-inline-block">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-sm btn-danger">
                    <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                </button>
            </form>
        </div>

        <div class="row">
            <div class="col-12 col-md-6">
                <div class="panel-section mb-3">
                    <h3 class="h5">Perfil de Usuario</h3>
                    <p class="mb-1"><strong>Nombre:</strong> @userName</p>
                    <p class="mb-1"><strong>Perfil activo:</strong> <span class="badge bg-primary">@activeProfile</span></p>
                    @if (string.Equals(activeProfile, "Psychologist", StringComparison.OrdinalIgnoreCase))
                    {
                        <p class="mb-0"><strong>Estado:</strong> <span class="badge @(isProfileVisible ? "bg-success" : "bg-warning text-dark")">@(isProfileVisible ? "Visible" : "Oculto")</span></p>
                    }
                </div>
            </div>

            <div class="col-12 col-md-6">
                <div class="panel-section mb-3">
                    <h3 class="h5">Notificaciones (@(pendingRequests.Count()) nuevas)</h3>
                    <div id="notifications-container" style="max-height: 200px; overflow-y: auto;">
                        @if (string.Equals(activeProfile, "Psychologist", StringComparison.OrdinalIgnoreCase))
                        {
                            @if (!pendingRequests.Any())
                            {
                                <p class="text-secondary">No tienes solicitudes de chat pendientes.</p>
                            }
                            else
                            {
                                <div id="pending-requests">
                                    @foreach (var request in pendingRequests)
                                    {
                                        <div class="notification-item" data-request-id="@request.Id">
                                            <h5 class="mt-0">Solicitud de Chat</h5>
                                            <p class="mb-1"><strong>Paciente:</strong> @(request.Patient?.User?.FullName ?? "Paciente")</p>
                                            <p class="text-truncate mb-2" style="max-width: 100%;"><strong>Mensaje:</strong> @request.InitialMessage</p>
                                            <div class="d-flex justify-content-end">
                                                <button type="button" class="btn-accept me-2" data-request-id="@request.Id">Aceptar</button>
                                                <button type="button" class="btn-reject" data-request-id="@request.Id">Rechazar</button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-secondary">Las notificaciones de respuesta aparecerán aquí.</p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="panel-section">
            <h3 class="h5">Chats Activos</h3>
            @if (!chats.Any())
            {
                <p class="text-secondary">No hay chats disponibles.</p>
            }
            else
            {
                <div class="chats-list" style="max-height: 350px; overflow-y: auto;">
                    @foreach (var chat in chats)
                    {
                        string personName = "";
                        if (string.Equals(activeProfile, "Patient", StringComparison.OrdinalIgnoreCase))
                        {
                            personName = chat.SessionRequest?.AssignedPsychologist?.User?.FullName ?? "Psicólogo";
                        }
                        else
                        {
                            personName = chat.SessionRequest?.Patient?.User?.FullName ?? "Paciente";
                        }

                        var lastMessage = (chat.Messages != null && ((IEnumerable<dynamic>)chat.Messages).Any())
                        ? ((IEnumerable<dynamic>)chat.Messages).Last().Message
                        : "Sin mensajes";

                        <div class="chat-item">
                            <div>
                                <h4 class="h6 mb-1 text-light">@personName</h4>
                                <p class="text-secondary mb-0 small text-truncate" style="max-width: 250px;">
                                    @(lastMessage.Length > 40 ? lastMessage.Substring(0, 40) + "..." : lastMessage)
                                </p>
                            </div>
                            <button type="button" class="btn-chat" data-chat-id="@chat.Id" data-person-name="@personName">
                                Chatear
                            </button>
                        </div>
                    }
                </div>
            }
        </div>

        <div class="panel-section">
            <div class="appointments-header">
                <h3 class="h5 mb-0">Mis Citas</h3>
                @if (string.Equals(activeProfile, "Psychologist", StringComparison.OrdinalIgnoreCase))
                {
                    <button type="button" id="search-appointments-btn" class="btn btn-sm btn-outline-info search-btn">
                        <i class="bi bi-search"></i> Buscar Citas
                    </button>
                }
            </div>

            <div id="appointments-list">
                @if (!appointments.Any())
                {
                    <p class="text-secondary mt-3">No tienes citas programadas.</p>
                }
                else
                {
                    <ul id="appointments-ul" style="max-height: 250px; overflow-y: auto;">
                        @foreach (var appt in appointments)
                        {
                            string personName = "";
                            if (string.Equals(activeProfile, "Patient", StringComparison.OrdinalIgnoreCase))
                            {
                                personName = appt.Psychologist?.User?.FullName ?? "Psicólogo";
                            }
                            else
                            {
                                personName = appt.Patient?.User?.FullName ?? "Paciente";
                            }

                            <li data-appointment-id="@appt.Id">
                                <div class="appointment-item">
                                    <div class="appointment-info">
                                        <strong class="text-warning">@personName</strong> -
                                        <span class="text-info">@appt.ScheduledAt.ToString("g")</span>
                                        @if (!string.IsNullOrEmpty(appt.Notes))
                                        {
                                            <div class="small text-secondary">Nota: @appt.Notes</div>
                                        }
                                    </div>
                                    @if (string.Equals(activeProfile, "Psychologist", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <div class="appointment-actions">
                                            <button type="button" class="btn btn-sm btn-outline-warning edit-appointment-btn" data-appointment-id="@appt.Id">Editar</button>
                                            <button type="button" class="btn btn-sm btn-outline-danger delete-appointment-btn" data-appointment-id="@appt.Id">Eliminar</button>
                                        </div>
                                    }
                                </div>
                            </li>
                        }
                    </ul>
                }
            </div>
        </div>


        @if (string.Equals(activeProfile, "Patient", StringComparison.OrdinalIgnoreCase))
        {
            <div class="panel-section psychologists-list">
                <h3 class="h5">Psicólogos Disponibles</h3>
                @if (!psychologists.Any())
                {
                    <p class="text-secondary">No hay psicólogos visibles en este momento.</p>
                }
                else
                {
                    <ul style="max-height: 350px; overflow-y: auto;">
                        @foreach (var psy in psychologists)
                        {
                            <li class="psychologist-item">
                                <div>
                                    <strong class="text-success">@(psy.User?.FullName ?? "Psicólogo")</strong>
                                    @if (!string.IsNullOrEmpty(psy.Bio))
                                    {
                                        <div class="small text-secondary text-truncate" style="max-width: 250px;">@psy.Bio</div>
                                    }
                                </div>
                                <div>
                                    <form method="post" asp-action="Create" asp-controller="SessionRequest" class="m-0">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="psychologistId" value="@psy.Id" />
                                        <button type="submit" class="start-chat-btn btn btn-sm">Solicitar chat</button>
                                    </form>
                                </div>
                            </li>
                        }
                    </ul>
                }
            </div>
        }
    </div>

    <div id="chat-sections-container">
        <div class="alert alert-info text-center">
            Haz clic en "Chatear" en la lista de Chats Activos para abrir una ventana de chat aquí.
        </div>
    </div>
</div>

@* Mantenemos los modales fuera del grid principal pero dentro del body *@

<div id="appointment-modal" class="modal">
    <div class="modal-content card">
        <h4 id="appointment-modal-title" class="text-center">Agendar Nueva Cita</h4>
        <form id="appointment-form">
            @Html.AntiForgeryToken()
            <input type="hidden" id="appointment-chat-id" />
            <input type="hidden" id="appointment-id" />
            <div class="mb-3">
                <label for="appointment-date" class="form-label">Fecha y Hora:</label>
                <input type="datetime-local" id="appointment-date" class="form-control" required />
            </div>
            <div class="mb-3">
                <label for="appointment-notes" class="form-label">Notas (opcional):</label>
                <textarea id="appointment-notes" rows="3" placeholder="Escriba notas adicionales para la cita..." class="form-control"></textarea>
            </div>
            <div class="modal-buttons">
                <button type="submit" class="btn-save" id="save-appointment-btn">Agendar Cita</button>
                <button type="button" class="btn-cancel">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<div id="search-modal" class="modal">
    <div class="modal-content card">
        <h4 class="text-center">Buscar Citas</h4>
        <form id="search-form">
            <div class="mb-3">
                <label for="search-patient-name" class="form-label">Nombre del Paciente:</label>
                <input type="text" id="search-patient-name" placeholder="Buscar por nombre..." class="form-control" />
            </div>
            <div class="mb-3">
                <label for="search-from-date" class="form-label">Desde:</label>
                <input type="date" id="search-from-date" class="form-control" />
            </div>
            <div class="mb-3">
                <label for="search-to-date" class="form-label">Hasta:</label>
                <input type="date" id="search-to-date" class="form-control" />
            </div>
            <div class="modal-buttons">
                <button type="submit" class="btn-search">Buscar</button>
                <button type="button" class="btn-clear">Limpiar Filtros</button>
                <button type="button" class="btn-cancel">Cancelar</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <script>
        const userName = "@userName";
        const userId = "@userId";
        const activeProfile = "@activeProfile";

        const notificationConnection = new signalR.HubConnectionBuilder()
            .withUrl("/notificationhub")
            .withAutomaticReconnect()
            .build();

        // Objetos para gestionar múltiples chats y modals
        const activeChats = new Map(); // chatId -> { element, connection, isConnected }
        const chatSectionsContainer = document.getElementById("chat-sections-container");
        const appointmentModal = document.getElementById("appointment-modal");
        const searchModal = document.getElementById("search-modal");
        let isEditMode = false;

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub")
            .withAutomaticReconnect()
            .build();

        function createChatSection(chatId, personName) {
            const chatSection = document.createElement("div");
            chatSection.className = "chat-section";
            chatSection.id = `chat-section-${chatId}`;

            // Agregar botón "Agendar cita" solo para psicólogos
            const appointmentButton = activeProfile === "Psychologist"
                ? `<button type="button" class="schedule-appointment-btn" data-chat-id="${chatId}">Agendar cita</button>`
                : '';

            chatSection.innerHTML = `
                <div class="chat-header">
                    <h3>Chat con ${personName}</h3>
                    <div class="chat-actions">
                        ${appointmentButton}
                        <button type="button" class="close-chat-btn" data-chat-id="${chatId}">Cerrar Chat</button>
                    </div>
                </div>
                <div class="messages" id="messages-${chatId}"></div>
                <div class="chat-input">
                    <input type="text" class="message-input" id="messageInput-${chatId}" placeholder="Escribe un mensaje..." />
                    <button class="send-btn" data-chat-id="${chatId}">Enviar</button>
                </div>
                <div class="connection-status" id="connectionStatus-${chatId}"></div>
            `;

            return chatSection;
        }

        function showStatus(chatId, message) {
            const statusDiv = document.getElementById(`connectionStatus-${chatId}`);
            if (statusDiv) statusDiv.textContent = message;
        }

        function openChat(selectedChatId, personName) {
            // Si el chat ya está abierto, no hacer nada
            if (activeChats.has(selectedChatId)) {
                return;
            }

            // Crear nueva sección de chat
            const chatSection = createChatSection(selectedChatId, personName);
            chatSectionsContainer.appendChild(chatSection);

            const messagesDiv = document.getElementById(`messages-${selectedChatId}`);
            const messageInput = document.getElementById(`messageInput-${selectedChatId}`);

            // Agregar event listener para el input de mensajes
            messageInput.addEventListener("keypress", (e) => {
                if (e.key === 'Enter') {
                    sendMessage(selectedChatId);
                    e.preventDefault();
                }
            });

            // Registrar el chat activo
            activeChats.set(selectedChatId, {
                element: chatSection,
                messagesDiv: messagesDiv,
                messageInput: messageInput,
                isConnected: false
            });

            // Conectar al chat específico
            if (connection.state === signalR.HubConnectionState.Connected) {
                showStatus(selectedChatId, "Conectando al chat...");
                connection.invoke("JoinChat", selectedChatId)
                    .then(() => {
                        showStatus(selectedChatId, "Conectado al chat");
                        activeChats.get(selectedChatId).isConnected = true;
                        console.log(`Conectado al chat ${selectedChatId}, esperando historial...`);
                    })
                    .catch(err => {
                        console.error("Error al unirse al chat:", err);
                        showStatus(selectedChatId, "Error al unirse al chat");
                    });
            } else {
                showStatus(selectedChatId, "Esperando conexión...");
            }
        }

        function closeChat(chatId) {
            const chatInfo = activeChats.get(chatId);
            if (!chatInfo) return;

            // Desconectar del chat
            if (chatInfo.isConnected) {
                connection.invoke("LeaveChat", chatId);
            }

            // Remover el elemento del DOM
            chatInfo.element.remove();

            // Remover del mapa de chats activos
            activeChats.delete(chatId);
        }

        function sendMessage(chatId) {
            const chatInfo = activeChats.get(chatId);
            if (!chatInfo) return;

            const message = chatInfo.messageInput.value.trim();
            if (message && connection && chatInfo.isConnected) {
                connection.invoke("SendMessage", chatId, message, userName)
                    .then(() => {
                        chatInfo.messageInput.value = "";
                    })
                    .catch(() => showStatus(chatId, "Error al enviar mensaje"));
            } else if (!chatInfo.isConnected) {
                showStatus(chatId, "No conectado al chat");
            }
        }

        // Funciones para manejar el modal de citas
        function openAppointmentModal(chatId = null, appointmentId = null) {
            isEditMode = appointmentId !== null;

            document.getElementById("appointment-chat-id").value = chatId || '';
            document.getElementById("appointment-id").value = appointmentId || '';

            const title = document.getElementById("appointment-modal-title");
            const saveBtn = document.getElementById("save-appointment-btn");

            if (isEditMode) {
                title.textContent = "Editar Cita";
                saveBtn.textContent = "Actualizar Cita";

                // Cargar datos de la cita
                loadAppointmentData(appointmentId);
            } else {
                title.textContent = "Agendar Nueva Cita";
                saveBtn.textContent = "Agendar Cita";

                // Establecer fecha mínima como mañana
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(9, 0, 0, 0);

                const dateInput = document.getElementById("appointment-date");
                dateInput.min = new Date().toISOString().slice(0, 16);
                dateInput.value = tomorrow.toISOString().slice(0, 16);
            }

            appointmentModal.style.display = "block";
        }

        function loadAppointmentData(appointmentId) {
            fetch(`/Appointment/Get?appointmentId=${appointmentId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById("appointment-date").value = data.appointment.scheduledAt;
                        document.getElementById("appointment-notes").value = data.appointment.notes;
                    } else {
                        alert("Error al cargar los datos de la cita: " + data.error);
                    }
                })
                .catch(err => {
                    console.error("Error:", err);
                    alert("Error al cargar los datos de la cita");
                });
        }

        function closeAppointmentModal() {
            appointmentModal.style.display = "none";
            document.getElementById("appointment-form").reset();
            isEditMode = false;
        }

        function scheduleOrUpdateAppointment() {
            const chatId = document.getElementById("appointment-chat-id").value;
            const appointmentId = document.getElementById("appointment-id").value;
            const scheduledAt = document.getElementById("appointment-date").value;
            const notes = document.getElementById("appointment-notes").value;

            if (!scheduledAt) {
                alert("Por favor seleccione una fecha y hora para la cita");
                return;
            }

            const url = isEditMode ? '/Appointment/Update' : '/Appointment/Create';
            let body = `scheduledAt=${encodeURIComponent(scheduledAt)}&notes=${encodeURIComponent(notes)}`;

            if (isEditMode) {
                body += `&appointmentId=${appointmentId}`;
            } else {
                body += `&chatId=${chatId}`;
            }

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: body
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    closeAppointmentModal();
                    location.reload();
                } else {
                    alert("Error: " + data.error);
                }
            })
            .catch(err => {
                console.error("Error:", err);
                alert("Error al procesar la cita");
            });
        }

        function deleteAppointment(appointmentId) {
            if (!confirm("¿Estás seguro de que deseas eliminar esta cita?")) {
                return;
            }

            fetch('/Appointment/Delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: `appointmentId=${appointmentId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    // Remover la cita de la lista
                    const appointmentItem = document.querySelector(`li[data-appointment-id="${appointmentId}"]`);
                    if (appointmentItem) {
                        appointmentItem.remove();
                    }
                } else {
                    alert("Error: " + data.error);
                }
            })
            .catch(err => {
                console.error("Error:", err);
                alert("Error al eliminar la cita");
            });
        }

        function openSearchModal() {
            searchModal.style.display = "block";
        }

        function closeSearchModal() {
            searchModal.style.display = "none";
            document.getElementById("search-form").reset();
        }

        function searchAppointments() {
            const patientName = document.getElementById("search-patient-name").value;
            const fromDate = document.getElementById("search-from-date").value;
            const toDate = document.getElementById("search-to-date").value;

            let url = '/Appointment/Search?';
            const params = [];

            if (patientName) params.push(`patientName=${encodeURIComponent(patientName)}`);
            if (fromDate) params.push(`fromDate=${encodeURIComponent(fromDate)}`);
            if (toDate) params.push(`toDate=${encodeURIComponent(toDate)}`);

            url += params.join('&');

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateAppointmentsList(data.appointments);
                        closeSearchModal();
                    } else {
                        alert("Error en la búsqueda: " + data.error);
                    }
                })
                .catch(err => {
                    console.error("Error:", err);
                    alert("Error al buscar citas");
                });
        }

        function updateAppointmentsList(appointments) {
            const appointmentsList = document.getElementById("appointments-ul");
            appointmentsList.innerHTML = "";

            if (appointments.length === 0) {
                appointmentsList.innerHTML = '<li>No se encontraron citas que coincidan con los criterios de búsqueda.</li>';
                return;
            }

            appointments.forEach(appt => {
                const listItem = document.createElement("li");
                listItem.setAttribute("data-appointment-id", appt.id);

                listItem.innerHTML = `
                    <div class="appointment-item">
                        <div class="appointment-info">
                            <strong>${appt.patientName}</strong> - ${appt.scheduledAtFormatted}
                            ${appt.notes ? `<div>${appt.notes}</div>` : ''}
                        </div>
                        ${activeProfile === "Psychologist" ? `
                        <div class="appointment-actions">
                            <button type="button" class="edit-appointment-btn" data-appointment-id="${appt.id}">Editar</button>
                            <button type="button" class="delete-appointment-btn" data-appointment-id="${appt.id}">Eliminar</button>
                        </div>
                        ` : ''}
                    </div>
                `;

                appointmentsList.appendChild(listItem);
            });
        }

        function clearSearchFilters() {
            document.getElementById("search-form").reset();
            location.reload(); // Recargar para mostrar todas las citas
        }

        document.addEventListener("click", function(e) {
            if (e.target.classList.contains("btn-chat")) {
                const selectedChatId = parseInt(e.target.getAttribute("data-chat-id"));
                const personName = e.target.getAttribute("data-person-name");
                openChat(selectedChatId, personName);
            } else if (e.target.classList.contains("close-chat-btn")) {
                const chatId = parseInt(e.target.getAttribute("data-chat-id"));
                closeChat(chatId);
            } else if (e.target.classList.contains("send-btn")) {
                const chatId = parseInt(e.target.getAttribute("data-chat-id"));
                sendMessage(chatId);
            } else if (e.target.classList.contains("schedule-appointment-btn")) {
                const chatId = parseInt(e.target.getAttribute("data-chat-id"));
                openAppointmentModal(chatId);
            } else if (e.target.classList.contains("edit-appointment-btn")) {
                const appointmentId = parseInt(e.target.getAttribute("data-appointment-id"));
                openAppointmentModal(null, appointmentId);
            } else if (e.target.classList.contains("delete-appointment-btn")) {
                const appointmentId = parseInt(e.target.getAttribute("data-appointment-id"));
                deleteAppointment(appointmentId);
            } else if (e.target.id === "search-appointments-btn") {
                openSearchModal();
            } else if (e.target.classList.contains("btn-accept")) {
                const requestId = e.target.getAttribute("data-request-id");
                handleSessionRequest(requestId, "Accept", e.target.closest(".notification-item"));
            } else if (e.target.classList.contains("btn-reject")) {
                const requestId = e.target.getAttribute("data-request-id");
                handleSessionRequest(requestId, "Reject", e.target.closest(".notification-item"));
            } else if (e.target.classList.contains("btn-cancel")) {
                closeAppointmentModal();
                closeSearchModal();
            } else if (e.target.classList.contains("btn-search")) {
                e.preventDefault();
                searchAppointments();
            } else if (e.target.classList.contains("btn-clear")) {
                e.preventDefault();
                clearSearchFilters();
            }
        });

        // Event listener para el formulario de citas
        document.getElementById("appointment-form").addEventListener("submit", function(e) {
            e.preventDefault();
            scheduleOrUpdateAppointment();
        });

        // Cerrar modals si se hace clic fuera de ellos
        window.addEventListener("click", function(e) {
            if (e.target === appointmentModal) {
                closeAppointmentModal();
            }
            if (e.target === searchModal) {
                closeSearchModal();
            }
        });

        notificationConnection.on("ReceiveChatRequest", (data) => {
            const container = document.getElementById("notifications-container");
            const newNotification = document.createElement("div");
            newNotification.className = "notification-item";
            newNotification.setAttribute("data-request-id", data.SessionRequestId);

            newNotification.innerHTML = `
                <h5>Nueva Solicitud de Chat</h5>
                <p><strong>Paciente:</strong> ${data.PatientName}</p>
                <p><strong>Mensaje:</strong> ${data.InitialMessage}</p>
                <div>
                    <button type="button" class="btn-accept" data-request-id="${data.SessionRequestId}">
                        Aceptar
                    </button>
                    <button type="button" class="btn-reject" data-request-id="${data.SessionRequestId}">
                        Rechazar
                    </button>
                </div>
            `;

            container.prepend(newNotification);
        });

        notificationConnection.on("ReceiveChatRequestResponse", (data) => {
            const container = document.getElementById("notifications-container");
            const responseNotification = document.createElement("div");

            responseNotification.innerHTML = `
                <h5>${data.Accepted ? 'Solicitud Aceptada' : 'Solicitud Rechazada'}</h5>
                <p><strong>Psicólogo:</strong> ${data.PsychologistName}</p>
                <p>${data.Accepted ? 'Tu solicitud de chat ha sido aceptada. Puedes comenzar a chatear.' : 'Tu solicitud de chat ha sido rechazada.'}</p>
            `;

            container.prepend(responseNotification);

            if (data.Accepted) {
                setTimeout(() => location.reload(), 3000);
            }
        });

        notificationConnection.start()
            .then(() => {
                console.log("Conexión de notificaciones iniciada");
                notificationConnection.invoke("JoinUserGroup", userId);
            })
            .catch(err => console.error("Error al conectar notificaciones:", err));

        function handleSessionRequest(requestId, action, notificationElement) {
            fetch(`/SessionRequest/${action}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "RequestVerificationToken": document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: `sessionRequestId=${requestId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    notificationElement.innerHTML = `
                        <h5>Solicitud ${action === "Accept" ? "Aceptada" : "Rechazada"}</h5>
                        <p>La solicitud ha sido procesada correctamente.</p>
                    `;

                    setTimeout(() => {
                        notificationElement.remove();
                        if (action === "Accept") {
                            location.reload();
                        }
                    }, 3000);
                } else {
                    alert("Error: " + data.error);
                }
            })
            .catch(err => {
                console.error("Error:", err);
                alert("Error al procesar la solicitud");
            });
        }

        // Actualizar el handler de ReceiveMessage para incluir timestamp
        if (connection) {
            connection.on("ReceiveMessage", (chatIdReceived, message, sender, timestamp) => {
                console.log(`Mensaje recibido para chat ${chatIdReceived}:`, { message, sender, timestamp });
                
                const chatInfo = activeChats.get(chatIdReceived);
                if (chatInfo) {
                    // Formatear el timestamp si está disponible
                    const timeDisplay = timestamp ? `<span class="timestamp">${timestamp}</span>` : '';
                    
                    chatInfo.messagesDiv.innerHTML += `
                        <div class="message">
                            <strong>${sender}:</strong> ${message} ${timeDisplay}
                        </div>`;
                    
                    // Scroll automático al final
                    chatInfo.messagesDiv.scrollTop = chatInfo.messagesDiv.scrollHeight;
                } else {
                    console.log(`Chat ${chatIdReceived} no está activo, ignorando mensaje`);
                }
            });

            // Agregar handler para errores del chat
            connection.on("Error", (errorMessage) => {
                console.error("Error del chat:", errorMessage);
                alert("Error: " + errorMessage);
            });

            connection.onreconnecting(() => {
                activeChats.forEach((chatInfo, chatId) => {
                    showStatus(chatId, "Reconectando...");
                });
            });

            connection.onreconnected(() => {
                activeChats.forEach((chatInfo, chatId) => {
                    showStatus(chatId, "Reconectado");
                    if (chatInfo.isConnected) {
                        connection.invoke("JoinChat", chatId)
                            .then(() => {
                                console.log(`Reconectado al chat ${chatId}`);
                            })
                            .catch(err => {
                                console.error(`Error al reconectar al chat ${chatId}:`, err);
                            });
                    }
                });
            });

            connection.onclose(() => {
                activeChats.forEach((chatInfo, chatId) => {
                    showStatus(chatId, "Conexión perdida. Recargando...");
                });
                setTimeout(() => location.reload(), 2000);
            });

            connection.start()
                .then(() => {
                    console.log("Conectado al servidor SignalR");
                })
                .catch((err) => {
                    console.error("Error al conectar con SignalR:", err);
                    console.log("Error al conectar. Recargando...");
                    setTimeout(() => location.reload(), 2000);
                });
        }

        window.addEventListener("beforeunload", () => {
            if (connection && connection.state === signalR.HubConnectionState.Connected) {
                activeChats.forEach((chatInfo, chatId) => {
                    if (chatInfo.isConnected) {
                        connection.invoke("LeaveChat", chatId);
                    }
                });
            }
            if (notificationConnection && notificationConnection.state === signalR.HubConnectionState.Connected) {
                notificationConnection.invoke("LeaveUserGroup", userId);
            }
        });
    </script>
}