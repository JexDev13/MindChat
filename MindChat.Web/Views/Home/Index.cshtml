@{
    ViewData["Title"] = "MindChat";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div>
    <div>
        <h2>Bienvenido @ViewData["UserName"]</h2>
        <p><strong>Perfil activo:</strong> @ViewData["ActiveProfile"]</p>

        <form method="post" action="@Url.Action("SwitchProfile", "Home")" id="switchProfileForm">
            @Html.AntiForgeryToken()
            <button type="submit" id="switchBtn">
                Cambiar a @(ViewData["ActiveProfile"].ToString() == "Patient" ? "Psicólogo" : "Paciente")
            </button>
        </form>
    </div>

    <div>
        <div>
            <h3>Chat con @ViewData["ParticipantName"]</h3>
        </div>

        <div id="messages">
            <!-- Mensajes -->
        </div>

        <div>
            <input type="text" id="messageInput" placeholder="Escribe un mensaje..." />
            <button id="sendBtn">Enviar</button>
        </div>
    </div>

    <div id="connectionStatus"></div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <script>
        const chatId = @ViewData["ChatId"];
        const userName = "@ViewData["UserName"]";
        const statusDiv = document.getElementById("connectionStatus");

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub")
            .withAutomaticReconnect()
            .build();

        function showStatus(message) {
            statusDiv.textContent = message;
        }

        connection.on("ReceiveMessage", (chatIdReceived, message, sender) => {
            if (chatIdReceived === chatId) {
                const msgDiv = document.getElementById("messages");
                const isCurrentUser = sender === userName;

                const messageHtml = `
                    <div>
                        <div>
                            <div>
                                ${sender}
                            </div>
                            <div>${message}</div>
                            <div>
                                ${new Date().toLocaleTimeString('es-EC', { hour: '2-digit', minute: '2-digit' })}
                            </div>
                        </div>
                    </div>
                `;

                msgDiv.innerHTML += messageHtml;
                msgDiv.scrollTop = msgDiv.scrollHeight;
            }
        });

        connection.onreconnecting(() => {
            showStatus("Reconectando...");
        });

        connection.onreconnected(() => {
            showStatus("Reconectado");
            connection.invoke("JoinChat", chatId);
        });

        connection.onclose(() => {
            showStatus("Conexión perdida. Recargando...");
            setTimeout(() => location.reload(), 2000);
        });

        connection.start()
            .then(() => {
                showStatus("Conectado");
                return connection.invoke("JoinChat", chatId);
            })
            .catch(() => {
                showStatus("Error al conectar. Recargando...");
                setTimeout(() => location.reload(), 2000);
            });

        function sendMessage() {
            const input = document.getElementById("messageInput");
            const message = input.value.trim();

            if (message !== "") {
                connection.invoke("SendMessage", chatId, message, userName)
                    .then(() => {
                        input.value = "";
                    })
                    .catch(() => {
                        showStatus("Error al enviar mensaje");
                    });
            }
        }

        document.getElementById("sendBtn").addEventListener("click", sendMessage);

        document.getElementById("messageInput").addEventListener("keypress", function (e) {
            if (e.key === 'Enter') {
                sendMessage();
                e.preventDefault();
            }
        });

        window.addEventListener("beforeunload", () => {
            if (connection.state === signalR.HubConnectionState.Connected) {
                connection.invoke("LeaveChat", chatId);
            }
        });
    </script>
}
